# Verbose 模式使用指南

## 概述

新增的 `verbose` 字段可以显示详细的矩阵计算结果，帮助调试和分析 GEMM 实现的问题。

## 配置方法

在 `config.yaml` 中添加 `verbose` 字段：

```yaml
operators:
  gemm:
    verbose: true  # 启用详细输出
    matrix_sizes: [8, 16, 32]  # 建议使用较小的矩阵
    init_method: one-one       # 选择合适的初始化方法
```

## 输出内容

### 1. 输入矩阵显示（小矩阵 ≤8×8）

```
═══════════════════════════════════════════════════════════════
  Input Matrices
═══════════════════════════════════════════════════════════════

Matrix A (8 × 8):
    0       1       2       3       4       5       6       7       
    ----------------------------------------------------------------
0  :1.000   1.000   1.000   1.000   1.000   1.000   1.000   1.000   
1  :1.000   1.000   1.000   1.000   1.000   1.000   1.000   1.000   
...
```

### 2. 结果矩阵对比

```
═══════════════════════════════════════════════════════════════
  Matrix Comparison: cute vs cuBLAS (Matrix C)
═══════════════════════════════════════════════════════════════
Matrix size: 8 × 8
Total errors: 61 / 64 (95.31%)
Max error: 56.000000
Error threshold: 0.150000

Color legend: Correct | Error | Severe
```

### 3. 颜色编码（终端支持）

- 🟢 **绿色**: 正确的值（误差 < threshold × 0.1）
- 🟡 **黄色背景**: 中等误差（threshold < 误差 < threshold × 10）
- 🔴 **红色背景**: 严重误差（误差 > threshold × 10）

### 4. 智能区域显示

对于大矩阵（>16×16），自动显示：
- **Top-Left Corner**: 左上角区域
- **Error Region 1,2,3**: 错误最多的区域
- **Bottom-Right Corner**: 右下角区域

## 使用场景

### 场景 1: 验证简单计算

```yaml
gemm:
  verbose: true
  init_method: one-one
  matrix_sizes: [4, 8]
```

**用途**: 验证基本的矩阵乘法逻辑
**预期**: 4×4 全1矩阵相乘，结果每个元素应该是 4.0

### 场景 2: 分析错误模式

```yaml
gemm:
  verbose: true
  init_method: range-range
  matrix_sizes: [8, 16]
```

**用途**: 查看具体的数值模式，分析 layout 问题
**优势**: 可以看到是否有规律性的错误（如转置、偏移等）

### 场景 3: 调试大矩阵问题

```yaml
gemm:
  verbose: true
  init_method: one-one
  matrix_sizes: [32, 64]
```

**用途**: 在大矩阵上定位错误区域
**功能**: 自动检测错误最多的 8×8 块并显示

### 场景 4: 对比不同实现

```yaml
# 第一次运行
gemm:
  impl: cute
  verbose: true
  init_method: one-one
  matrix_sizes: [16]

# 第二次运行
gemm:
  impl: cuda
  verbose: true
  init_method: one-one
  matrix_sizes: [16]
```

**用途**: 对比两个实现的具体差异

## 实际调试示例

### 示例 1: WGMMA Layout 问题

**配置**:
```yaml
impl: cute
init_method: one-one
matrix_sizes: [8]
verbose: true
```

**观察到的问题**:
```
Expected: 8.0 (每个元素)
Got: 64.0, 56.0, 48.0, ... (第一行)
     0.0, 0.0, 0.0, ...    (其他行)
```

**分析**: 
- 第一行的值是 64, 56, 48... 说明可能是列索引相关的计算
- 其他行都是 0，说明只有第一行在计算
- 这表明 WGMMA 的 shared memory layout 或 stride 配置有问题

### 示例 2: 转置问题

**配置**:
```yaml
init_method: range-range
matrix_sizes: [4]
```

**如果看到**:
```
Expected: A[i,:] × B[:,j] 的结果
Got: A[:,i] × B[j,:] 的结果
```

**分析**: 说明矩阵被意外转置了

### 示例 3: 数值精度问题

**配置**:
```yaml
init_method: rand-rand
matrix_sizes: [16]
```

**如果看到**:
- 大部分元素接近正确值
- 误差随机分布
- 没有明显的模式

**分析**: 这是正常的数值精度问题，不是算法错误

## 配置建议

### 矩阵大小选择

| 目的 | 推荐大小 | 原因 |
|------|----------|------|
| 验证逻辑 | 4, 8 | 可以手算验证 |
| 调试 layout | 8, 16 | 能看到完整模式 |
| 性能分析 | 32, 64 | 接近实际使用 |
| 错误定位 | 16, 32 | 平衡细节和概览 |

### 初始化方法选择

| 方法 | 适用场景 | 优势 |
|------|----------|------|
| `one-one` | 基本验证 | 结果可预测 |
| `range-range` | Layout 调试 | 能看到索引模式 |
| `row-col` | 转置检测 | 能发现转置问题 |
| `rand-rand` | 精度测试 | 接近实际使用 |

## 性能影响

- **小矩阵** (≤16): 几乎无影响
- **中等矩阵** (32-64): 轻微影响（额外的内存拷贝）
- **大矩阵** (≥128): 建议关闭 verbose 或使用更小的测试矩阵

## 注意事项

1. **终端支持**: 颜色编码需要支持 ANSI 的终端
2. **输出长度**: 大矩阵会产生很长的输出
3. **内存使用**: verbose 模式会额外分配主机内存
4. **调试专用**: 不建议在性能测试时开启

## 故障排除

### 问题: 没有颜色显示
**解决**: 检查终端是否支持 ANSI 颜色，或在配置中设置 `use_colors: false`

### 问题: 输出太长
**解决**: 使用更小的矩阵或调整 `max_rows/max_cols` 参数

### 问题: NaN 值
**解决**: 检查输入数据和数值溢出问题

## 总结

Verbose 模式是调试 GEMM 实现的强大工具，特别适合：
- ✅ 验证算法正确性
- ✅ 分析错误模式
- ✅ 调试 layout 问题
- ✅ 对比不同实现

通过合理配置矩阵大小和初始化方法，可以快速定位和解决问题。